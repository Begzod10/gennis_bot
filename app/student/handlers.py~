# handlers.py
import os
import requests
from aiogram import F, types, Router
from aiogram.types import Message, KeyboardButton, ReplyKeyboardMarkup, ReplyKeyboardRemove
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import StatesGroup, State
from aiogram.filters.state import StateFilter
from dotenv import load_dotenv
from .keyboards import (
    create_years_reply_keyboard,
    create_months_inline_keyboard,
    student_basic_reply_keyboard,
    student_basic_reply_keyboard_test_type
)
from .utils import get_student
from app.student.tests import student_routers
from app.states import MenuStates

student_router = Router()
load_dotenv()


@student_router.message(F.text == "ğŸ’³ To'lovlar roâ€˜yhati")
async def get_payments_list(message: Message):
    api = os.getenv('API')
    telegram_id = message.from_user.id
    student = get_student(telegram_id)

    try:
        response = requests.get(f'{api}/api/bot/students/payments/{student.platform_id}')
        payments = response.json().get('payments', [])
    except Exception as e:
        await message.answer("âŒ Toâ€˜lovlar roâ€˜yhati olinmadi.")
        return

    if not payments:
        await message.answer("âš ï¸ To'lovlar topilmadi.")
        return

    text = f"ğŸ“‹ <b>{student.name}, so'nggi to'lovlar ro'yxati:</b>\n\n"
    text += "{:<15} {:<12} {:<10}\n".format("Sana", "Miqdor", "Turi")
    text += "-" * 40 + "\n"

    for pay in payments[:10]:
        text += "{:<5} {:<12} {:<10}\n".format(
            pay['date'], pay['amount'], pay['payment_type']
        )

    text += "\nâ¬†ï¸ Qo'shimcha savollar uchun adminlarimizga murojaat qiling."
    await message.answer(text, parse_mode="HTML")


@student_router.message(F.text.startswith("ğŸ¯ Test natijalari"))
async def test_types(message: Message):
    await message.answer(
        "ğŸ‘† Iltimos, quyidagilardan birini tanlang:",
        reply_markup=student_basic_reply_keyboard_test_type
    )


@student_router.message(F.text == "ğŸ“„ Offlayn test natijalari")
async def handle_test_results(message: Message):
    api = os.getenv('API')
    telegram_id = message.from_user.id
    student = get_student(telegram_id)

    try:
        response = requests.get(f'{api}/api/bot/students/test/results/{student.platform_id}')
        data = response.json()
        test_results = data.get('test_results', [])
    except Exception as e:
        await message.answer("âŒ Test natijalari olinmadi.")
        return

    if not test_results:
        await message.answer("âš ï¸ Test natijalari topilmadi.")
        return

    text = f"ğŸ“š <b>{student.name},  test natijalari:</b>\n\n"
    for group in test_results:
        group_name = group['name']
        subject_name = group['subject']
        teacher = group['teacher']
        tests = group['tests']

        text += (
            f"ğŸ‘¥ <b>Guruh:</b> {group_name}\n"
            f"ğŸ“š <b>Fan:</b> {subject_name}\n"
            f"ğŸ‘¨â€ğŸ« <b>O'qituvchi:</b> {teacher}\n"
        )

        if not tests:
            text += "âš ï¸ Test natijalari yo'q.\n"
        else:
            for result in tests:
                text += (
                    f"ğŸ“… <b>Sana:</b> {result['date']}\n"
                    f"âœ… <b>Natija:</b> {result['percentage']} "
                    f"({result['true_answers']} ta to'g'ri javob)\n"
                    f"ğŸ¯ <b>Test:</b> {result['test_info']['name']} "
                    f"(Daraja: {result['test_info']['level']})\n"
                )
                text += "â”" * 20 + "\n"
        text += "â•" * 25 + "\n\n"

    await message.answer(text, parse_mode="HTML")


@student_router.message(F.text == "ğŸ–¥ï¸ Onlayn test natijalari")
async def handle_online_test_results(message: Message):
    api = os.getenv('API')
    telegram_id = message.from_user.id
    student = get_student(telegram_id)

    try:
        response = requests.get(f'https://classroom.gennis.uz/api/pisa/student/pisa/results/{student.platform_id}')
        data = response.json()
        test_results = data.get('data', [])
    except Exception as e:
        await message.answer("âŒ Onlayn test natijalari olinmadi.")
        return

    if not test_results:
        await message.answer("âš ï¸ Onlayn test natijalari topilmadi.")
        return

    text = f"ğŸ’» <b>{student.name}, onlayn test natijalari:</b>\n\n"
    for result in test_results:
        text += (
            f"ğŸ“… <b>Sana:</b> {result['test_date']}\n"
            f"ğŸ“š <b>Test nomi:</b> {result['pisa_name']}\n"
            f"âœ… <b>Toâ€˜gâ€˜ri javoblar:</b> {result['true_answers']} ta\n"
            f"âŒ <b>Notoâ€˜gâ€˜ri javoblar:</b> {result['false_answers']} ta\n"
            f"ğŸ“Š <b>Natija:</b> {result['result']}%\n"
            f"ğŸ“‹ <b>Savollar soni:</b> {result['total_questions']} ta\n"
            f"ğŸŒ <b>Joylashuv:</b> {result['location']['name']}\n"
        )
        text += "â”" * 20 + "\n"

    await message.answer(text, parse_mode="HTML")


@student_router.message(F.text == "ğŸ“ Davomatlar roâ€˜yhati")
async def get_davomatlar_royxati(message: Message, state: FSMContext):
    api = os.getenv('API')
    await state.set_state(MenuStates.attendances)
    telegram_id = message.from_user.id
    student = get_student(telegram_id)

    try:
        response = requests.get(f'{api}/api/bot/students/attendance/dates/{student.platform_id}')
        dates_data = response.json()['data']
    except Exception as e:
        await message.answer("âŒ Davomatlar olinmadi.")
        return

    await state.update_data(
        mode="attendance",
        years=dates_data['years'],
        dates_info=dates_data,
        selected_year=None,
        selected_month=None
    )
    years_keyboard = create_years_reply_keyboard(dates_data)
    await message.answer("âœ… Yilni tanlang:", reply_markup=years_keyboard)


@student_router.message(lambda msg: msg.text and "baholar" in msg.text.lower())
async def get_baholar(message: Message, state: FSMContext):
    api = os.getenv('API')
    await state.set_state(MenuStates.scores)
    telegram_id = message.from_user.id
    student = get_student(telegram_id)

    try:
        response = requests.get(f'{api}/api/bot/students/attendance/dates/{student.platform_id}')
        dates_data = response.json()['data']
    except Exception as e:
        await message.answer("âŒ Baholar olinmadi.")
        return

    await state.update_data(
        mode="scores",
        years=dates_data['years'],
        dates_info=dates_data,
        selected_year=None,
        selected_month=None
    )
    years_keyboard = create_years_reply_keyboard(dates_data)
    await message.answer("âœ… Yilni tanlang:", reply_markup=years_keyboard)


@student_router.message(StateFilter(MenuStates.attendances, MenuStates.scores))
async def handle_dynamic_year_selection(message: Message, state: FSMContext):
    data = await state.get_data()
    if message.text in data.get("years", []):
        await state.update_data(selected_year=message.text)
        months_keyboard = create_months_inline_keyboard(data["dates_info"], message.text)
        await message.answer(f"âœ… Siz {message.text} yilni tanladingiz!")
        await message.answer("âœ… Shu yilning oylarini tanlang:", reply_markup=months_keyboard)


@student_router.callback_query(lambda c: c.data.startswith("month_"))
async def handle_month_selection(callback: types.CallbackQuery, state: FSMContext):
    api = os.getenv("API")
    telegram_id = callback.from_user.id
    month = callback.data.split("_")[1]

    await callback.message.answer(f"âœ… Siz {month} oyini tanladingiz!")
    data = await state.get_data()
    await state.update_data(selected_month=month)

    student = get_student(telegram_id)
    year = data.get("selected_year")
    mode = data.get("mode")

    try:
        if mode == "attendance":
            response = requests.get(f'{api}/api/bot/students/attendances/{student.platform_id}/{year}/{month}')
            tables = response.json().get("attendances", [])
        else:
            response = requests.get(f'{api}/api/bot/students/scores/{student.platform_id}/{year}/{month}')
            tables = response.json().get("score_list", [])
    except Exception as e:
        await callback.message.answer("âŒ Ma'lumotlar olinmadi.")
        return

    if not tables:
        await callback.message.answer(f"âš ï¸ {mode.capitalize()} topilmadi.")
        return

    text = f"ğŸ“… <b>{student.name}, {month} oyi:</b>\n\n"
    for table in tables:
        text += f"ğŸ”· <b>{table.get('subject', 'NomaÊ¼lum fan')} ({table.get('name', '')})</b>\n"
        text += f"ğŸ‘¨â€ğŸ« O'qituvchi: <i>{table.get('teacher', '')}</i>\n"

        if mode == "attendance":
            text += f"ğŸ“š Darslar:\n"
            for att in table.get("attendances", []):
                status_icon = "âœ…" if att.get("ball_status", 0) in [1, 2] else "âŒ"
                text += f"  ğŸ”¹ {att.get('day', '?')} {status_icon}\n"
        else:
            text += f"ğŸ“ˆ O'rtacha ball: <b>{table.get('average_ball', 0)}</b>\n"
            for score in table.get("score", []):
                text += f"  ğŸ”¹ {score.get('day', '?')} âœ…\n"

        text += "â”" * 25 + "\n\n"

    await callback.message.answer(text, parse_mode="HTML")
    months_keyboard = create_months_inline_keyboard(data["dates_info"], data["selected_year"])
    await callback.message.answer("âœ… Yana oy tanlang:", reply_markup=months_keyboard)


@student_router.message(F.text == "ğŸ“ Testni boshlash")
async def student_start_test(message: Message, state: FSMContext):
    await student_routers(message, state)
