# app/student/handlers.py
import os
import requests
from dotenv import load_dotenv
from aiogram import Router, F
from aiogram.types import Message, CallbackQuery, KeyboardButton, ReplyKeyboardMarkup, ReplyKeyboardRemove
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import StatesGroup, State

from .keyboards import (
    create_years_reply_keyboard,
    create_months_inline_keyboard,
    student_basic_reply_keyboard,
    student_basic_reply_keyboard_test_type
)
from .utils import get_student

years_data = {}
dates_info = {}
selected_student_year = {}
selected_student_month = {}
user_mode = {}

load_dotenv()
API = os.getenv("https://classroom.gennis.uz/api/pisa/test/crud/34")
GENNIS_TOKEN = os.getenv(
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJmcmVzaCI6ZmFsc2UsImlhdCI6MTc2MzAyOTU0NCwianRpIjoiMmFhOTJmNDAtNzc3ZC00ZTMwLTg4NjMtYmRjNmViMzdhN2JhIiwidHlwZSI6ImFjY2VzcyIsInN1YiI6IjhkMDI3NzJjNTE5MzExZjBhNTQ4MzFkODQyNzBhMjIwIiwibmJmIjoxNzYzMDI5NTQ0LCJjc3JmIjoiNDcyODg5YzMtNjU5Ni00YWMyLThlMDUtZWI3OTc0ODEzZmIzIiwiZXhwIjoxNzYzMTE1OTQ0fQ.MnJRRmuLN_y3nNf6_gybIsjaa4g8WcJvz56KgULVYAE")

student_router = Router()


class MenuStates(StatesGroup):
    attendances = State()
    scores = State()


class TestStates(StatesGroup):
    question_number = State()
    score = State()
    questions = State()
    test_id = State()
    answered_questions = State()


@student_router.message(F.text == "ğŸ’³ To'lovlar roâ€˜yhati")
async def get_payments_list(message: Message):
    telegram_id = message.from_user.id
    student = get_student(telegram_id)
    response = requests.get(f'{API}/api/bot/students/payments/{student.platform_id}')
    payments = response.json().get('payments', [])

    if not payments:
        await message.answer("âš ï¸ To'lovlar topilmadi.")
        return

    text = f"ğŸ“‹ <b>{student.name}, so'nggi to'lovlar ro'yxati:</b>\n\n"
    text += "{:<15} {:<12} {:<10}\n".format("Sana", "Miqdor", "Turi")
    text += "-" * 40 + "\n"
    for pay in payments:
        text += "{:<15} {:<12} {:<10}\n".format(
            pay['date'],
            pay['amount'],
            pay['payment_type']
        )
    text += "\nâ¬†ï¸ Qo'shimcha savollar uchun adminlarimizga murojaat qiling."
    await message.answer(text, parse_mode="HTML")


@student_router.message(F.text.startswith("ğŸ¯ Test natijalari"))
async def test_types(message: Message):
    await message.answer(
        "ğŸ‘† Iltimos, quyidagilardan birini tanlang:",
        reply_markup=student_basic_reply_keyboard_test_type
    )


@student_router.message(F.text == "ğŸ“„ Offlayn test natijalari")
async def handle_test_results(message: Message):
    telegram_id = message.from_user.id
    student = get_student(telegram_id)
    response = requests.get(f'{API}/api/bot/students/test/results/{student.platform_id}')
    data = response.json()
    test_results = data.get('test_results', [])

    if not test_results:
        await message.answer("âš ï¸ Test natijalari topilmadi.")
        return

    text = f"ğŸ“š <b>{student.name}, test natijalari:</b>\n\n"
    for group in test_results:
        text += f"ğŸ‘¥ <b>Guruh:</b> {group['name']}\nğŸ“š <b>Fan:</b> {group['subject']}\nğŸ‘¨â€ğŸ« <b>O'qituvchi:</b> {group['teacher']}\n"
        tests = group.get('tests', [])
        if not tests:
            text += "âš ï¸ Test natijalari yo'q.\n"
        else:
            for result in tests:
                text += (
                    f"ğŸ“… <b>Sana:</b> {result['date']}\n"
                    f"âœ… <b>Natija:</b> {result['percentage']} ({result['true_answers']} ta to'g'ri javob)\n"
                    f"ğŸ¯ <b>Test:</b> {result['test_info']['name']} (Daraja: {result['test_info']['level']})\n"
                )
                text += "â”" * 20 + "\n"
        text += "â•" * 25 + "\n\n"

    await message.answer(text, parse_mode="HTML")


@student_router.message(F.text == "ğŸ–¥ï¸ Onlayn test natijalari")
async def handle_online_test_results(message: Message):
    telegram_id = message.from_user.id
    student = get_student(telegram_id)
    response = requests.get(f'https://classroom.gennis.uz/api/pisa/student/pisa/results/{student.platform_id}')
    data = response.json()
    test_results = data.get('data', [])

    if not test_results:
        await message.answer("âš ï¸ Onlayn test natijalari topilmadi.")
        return

    text = f"ğŸ’» <b>{student.name}, onlayn test natijalari:</b>\n\n"
    for result in test_results:
        text += (
            f"ğŸ“… <b>Sana:</b> {result['test_date']}\n"
            f"ğŸ“š <b>Test nomi:</b> {result['pisa_name']}\n"
            f"âœ… <b>Toâ€˜gâ€˜ri javoblar:</b> {result['true_answers']} ta\n"
            f"âŒ <b>Notoâ€˜gâ€˜ri javoblar:</b> {result['false_answers']} ta\n"
            f"ğŸ“Š <b>Natija:</b> {result['result']}%\n"
            f"ğŸ“‹ <b>Savollar soni:</b> {result['total_questions']} ta\n"
            f"ğŸŒ <b>Joylashuv:</b> {result['location']['name']}\n"
        )
        text += "â”" * 20 + "\n"

    await message.answer(text, parse_mode="HTML")


@student_router.message(F.text == "ğŸ“ Davomatlar roâ€˜yhati")
async def get_davomatlar_royxati(message: Message, state: FSMContext):
    await state.set_state(MenuStates.attendances)
    telegram_id = message.from_user.id
    student = get_student(telegram_id)
    response = requests.get(f'{API}/api/bot/students/attendance/dates/{student.platform_id}')
    dates_data = response.json()['data']
    await state.update_data(
        mode="attendance",
        years=dates_data['years'],
        dates_info=dates_data,
        selected_year=None,
        selected_month=None
    )
    years_keyboard = create_years_reply_keyboard(dates_data)
    await message.answer("âœ… Yilni tanlang:", reply_markup=years_keyboard)


@student_router.message(lambda msg: msg.text and "baholar" in msg.text.lower())
async def get_baholar(message: Message, state: FSMContext):
    await state.set_state(MenuStates.scores)
    telegram_id = message.from_user.id
    student = get_student(telegram_id)
    response = requests.get(f'{API}/api/bot/students/attendance/dates/{student.platform_id}')
    dates_data = response.json()['data']
    await state.update_data(
        mode="scores",
        years=dates_data['years'],
        dates_info=dates_data,
        selected_year=None,
        selected_month=None
    )
    years_keyboard = create_years_reply_keyboard(dates_data)
    await message.answer("âœ… Yilni tanlang:", reply_markup=years_keyboard)


@student_router.message(F.text)
async def handle_dynamic_year_selection(message: Message, state: FSMContext):
    data = await state.get_data()
    if "years" not in data or message.text not in data["years"]:
        return

    await state.update_data(selected_year=message.text)
    months_keyboard = create_months_inline_keyboard(data["dates_info"], message.text)
    await message.answer(f"âœ… Siz {message.text} yilni tanladingiz!")
    await message.answer("âœ… Shu yilning oylarini tanlang:", reply_markup=months_keyboard)


@student_router.callback_query(lambda c: c.data.startswith("month_"))
async def handle_month_selection(callback: CallbackQuery, state: FSMContext):
    data = await state.get_data()
    month = callback.data.split("_")[1]
    await state.update_data(selected_month=month)
    telegram_id = callback.from_user.id
    student = get_student(telegram_id)
    year = data.get("selected_year")
    mode = data.get("mode")

    if mode == "attendance":
        response = requests.get(f'{API}/api/bot/students/attendances/{student.platform_id}/{year}/{month}')
        tables = response.json().get("attendances", [])
        if not tables:
            await callback.message.answer("âš ï¸ Davomat topilmadi.")
            return
        text = f"ğŸ“… <b>{student.name}, sizning davomat jadvalingiz:</b>\n\n"
        for table in tables:
            text += f"ğŸ”· <b>{table['subject']} ({table['name']})</b>\nğŸ‘¨â€ğŸ« O'qituvchi: <i>{table['teacher']}</i>\nğŸ“š Darslar:\n"
            for attendance in table['attendances']:
                status_icon = "âœ…" if attendance["ball_status"] in [1, 2] else "âŒ"
                text += f"  ğŸ”¹ <b>{attendance['day']}</b> {status_icon}\n"
                if attendance["ball_status"] == 2:
                    text += f"    ğŸ“Œ Uy ishi: {attendance['homework']}\n"
                    if attendance.get("dictionary"):
                        text += f"    ğŸ“– Lug'at: {attendance['dictionary']}\n"
                    text += f"    ğŸ¯ Aktivlik: {attendance['activeness']}\n"
            text += "â”" * 25 + "\n\n"
        await callback.message.answer(text, parse_mode="HTML")

    elif mode == "scores":
        response = requests.get(f'{API}/api/bot/students/scores/{student.platform_id}/{year}/{month}')
        tables = response.json().get("score_list", [])
        if not tables:
            await callback.message.answer("âš ï¸ Baholar topilmadi.")
            return
        text = f"ğŸ“Š <b>{student.name}, {month} oyidagi baholar:</b>\n\n"
        for table in tables:
            text += f"ğŸ”· <b>{table['subject']} ({table['name']})</b>\nğŸ‘¨â€ğŸ« O'qituvchi: <i>{table['teacher']}</i>\nğŸ“ˆ O'rtacha ball: {table['average_ball']}\n"
            if not table['score']:
                text += "âš ï¸ Baholar mavjud emas.\n"
            else:
                text += "ğŸ“š Darslar boâ€˜yicha baholar:\n"
                for score in table['score']:
                    text += f"  ğŸ”¹ <b>{score['day']}</b> âœ…\n"
                    text += f"    ğŸ“Œ Uy ishi: {score['homework']}\n"
                    text += f"    ğŸ¯ Aktivlik: {score['activeness']}\n"
                    if score.get("dictionary"):
                        text += f"    ğŸ“– Lugâ€˜at: {score['dictionary']}\n"
            text += "â”" * 25 + "\n\n"
        await callback.message.answer(text, parse_mode="HTML")

    months_keyboard = create_months_inline_keyboard(data["dates_info"], data["selected_year"])
    await callback.message.answer("âœ… Yana oy tanlang:", reply_markup=months_keyboard)


TEST_LIST_URL = "https://classroom.gennis.uz/api/pisa/test/crud/34"


def HEADERS(token):
    return {
        "Authorization": f"Bearer {token}",
        "Accept": "application/json",
        "User-Agent": "GennisBot/1.0"
    }


def get_tests():
    try:
        resp = requests.get(TEST_LIST_URL, headers=HEADERS(GENNIS_TOKEN))
        data = resp.json()
        if isinstance(data, dict):
            return [{"id": data.get("id", 34), "name": data.get("name", "NomaÊ¼lum test")}]
        elif isinstance(data, list):
            return [{"id": t["id"], "name": t["name"]} for t in data if "id" in t and "name" in t]
    except Exception as e:
        print(f"Xato test olishda: {e}")
    return []


@student_router.message(F.text == "ğŸ“ Testni boshlash")
async def student_start_test(message: Message, state: FSMContext):
    tests = get_tests()
    if not tests:
        await message.answer("ğŸš« Hozircha testlar mavjud emas.")
        return

    buttons = [[KeyboardButton(text=t["name"])] for t in tests]
    buttons.append([KeyboardButton(text="â¬…ï¸ Orqaga")])
    keyboard = ReplyKeyboardMarkup(keyboard=buttons, resize_keyboard=True)
    await message.answer("ğŸ“‹ Iltimos, testni tanlang:", reply_markup=keyboard)
    await state.update_data(tests=tests)
    await state.set_state(TestStates.question_number)


@student_router.message(TestStates.question_number)
async def handle_test_selection(message: Message, state: FSMContext):
    data = await state.get_data()
    if message.text == "â¬…ï¸ Orqaga":
        await state.clear()
        await message.answer("ğŸ‘† Iltimos, testni tanlang:", reply_markup=student_basic_reply_keyboard_test_type)
        return

    tests = data.get("tests", [])
    selected = next((t for t in tests if t["name"] == message.text), None)
    if not selected:
        return

    await message.answer(f"âœ… Siz tanladingiz: <b>{selected['name']}</b>", parse_mode="HTML")
    await message.answer("ğŸ§  Test yuklanmoqda...", reply_markup=ReplyKeyboardRemove())

    # Get questions
    test_url = f"https://classroom.gennis.uz/api/pisa/student/get/test/{selected['id']}"
    resp = requests.get(test_url, headers=HEADERS(GENNIS_TOKEN))
    test_data = resp.json()

    questions = []
    for block in test_data.get("pisa_blocks_right", []):
        options = block.get("answers", [])
        if options:
            questions.append({
                "id": block.get("id"),
                "text": block.get("q", "Savol matni yo'q"),
                "answers": [{"text": o, "isTrue": idx == block.get("correct_answer_index", 0)} for idx, o in
                            enumerate(options)]
            })

    if not questions:
        await message.answer("â—ï¸ Bu testda savollar topilmadi.", reply_markup=student_basic_reply_keyboard_test_type)
        return

    await state.update_data(
        question_number=0,
        score=0,
        questions=questions,
        test_id=selected["id"],
        answered_questions=[]
    )
    await send_question(message, state)


async def send_question(message: Message, state: FSMContext):
    data = await state.get_data()
    q_num = data.get("question_number", 0)
    questions = data.get("questions", [])

    if q_num >= len(questions):
        await finish_test(message, state)
        return

    q = questions[q_num]
    options = q.get("answers", [])
    buttons = [[KeyboardButton(text=str(i + 1))] for i in range(len(options))]
    buttons.append([KeyboardButton(text="âŒ Testdan chiqish")])
    keyboard = ReplyKeyboardMarkup(keyboard=buttons, resize_keyboard=True)

    question_text = q.get("text", "Savol topilmadi")
    await message.answer(
        f"{question_text}\n\n" + "\n".join(f"{i + 1}. {opt['text']}" for i, opt in enumerate(options)),
        reply_markup=keyboard
    )


@student_router.message(TestStates.question_number, F.text == "âŒ Testdan chiqish")
async def exit_test(message: Message, state: FSMContext):
    await state.clear()
    await message.answer("ğŸšª Siz testdan chiqdingiz.", reply_markup=student_basic_reply_keyboard_test_type)


@student_router.message(TestStates.question_number, F.text.regexp(r"^\d+$"))
async def answer_question(message: Message, state: FSMContext):
    data = await state.get_data()
    q_num = data.get("question_number", 0)
    score = data.get("score", 0)
    questions = data.get("questions", [])
    answered_questions = data.get("answered_questions", [])

    if q_num >= len(questions):
        await finish_test(message, state)
        return

    q = questions[q_num]
    options = q.get("answers", [])
    user_answer = int(message.text)
    correct_index = next((i + 1 for i, a in enumerate(options) if a["isTrue"]), None)
    answered_questions.append(q["text"])

    if 1 <= user_answer <= len(options):
        if user_answer == correct_index:
            score += 1
            await message.answer("âœ… Toâ€˜gâ€˜ri!")
        else:
            correct_text = options[correct_index - 1]["text"] if correct_index else "?"
            await message.answer(f"âŒ Notoâ€˜gâ€˜ri!\nToâ€˜gâ€˜ri javob: {correct_text}")

    await state.update_data(
        question_number=q_num + 1,
        score=score,
        answered_questions=answered_questions
    )
    await send_question(message, state)


async def finish_test(message: Message, state: FSMContext):
    data = await state.get_data()
    score = data.get("score", 0)
    total = len(data.get("questions", []))
    percent = round((score / total) * 100) if total else 0
    answered_questions = data.get("answered_questions", [])

    await message.answer(
        f"âœ… Test tugadi!\nSiz {score}/{total} toâ€˜gâ€˜ri javob berdingiz.\nğŸ“Š Foiz: {percent}%\nğŸ“„ Javob bergan savollar:\n" +
        "\n".join(answered_questions),
        reply_markup=student_basic_reply_keyboard_test_type
    )
    await state.clear()
