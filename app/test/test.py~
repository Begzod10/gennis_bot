from aiogram import Bot, Dispatcher, types, F
from aiogram.utils.keyboard import InlineKeyboardBuilder
from aiogram.fsm.context import FSMContext
import asyncio
from app.db import async_session
from app.student.models import TestResult
from app.test.questions import HTML_TEST

BOT_TOKEN = "TOKENINGIZNI_KIRITING"
bot = Bot(token=BOT_TOKEN, parse_mode="HTML")
dp = Dispatcher()


# === Test boshlash handler ===
@dp.message(F.text == "üìù Testni boshlash")
async def start_test_handler(message: types.Message, state: FSMContext):
    await message.answer("üß† HTML testi boshlanmoqda...\n‚è≥ 10 soniyadan keyin birinchi savol chiqadi!")
    await state.update_data(index=0, correct=0, answers={})

    # Countdown
    msg = await message.answer("‚è≥ <b>10 soniya qoldi...</b>")
    for i in range(10, 0, -1):
        await msg.edit_text(f"‚è≥ <b>{i} soniya qoldi...</b>")
        await asyncio.sleep(1)
    await send_question(message, state)


# === Savol jo'natish ===
async def send_question(message: types.Message, state: FSMContext):
    data = await state.get_data()
    index = data.get("index", 0)

    if index >= len(HTML_TEST):
        correct = data.get("correct", 0)
        total = len(HTML_TEST)
        percent = (correct / total) * 100

        await message.answer(f"üéâ Test tugadi!\nNatija: <b>{correct}/{total}</b> ({percent:.1f}%)")

        # DB ga saqlash
        user_id = message.from_user.id
        answers = data.get("answers", {})
        test_type = "HTML/CSS"
        async with async_session() as session:
            result = TestResult(
                user_id=user_id,
                student_id=None,
                test_type=test_type,
                total_questions=total,
                correct_answers=correct,
                percent=percent,
                answers=answers
            )
            session.add(result)
            await session.commit()

        await state.clear()
        return

    q = HTML_TEST[index]
    builder = InlineKeyboardBuilder()
    for i, option in enumerate(q["options"]):
        builder.button(text=option, callback_data=f"answer_{index}_{i}")
    builder.adjust(1)

    await message.answer(f"üß© <b>{q['q']}</b>", reply_markup=builder.as_markup())


# === Javob handler ===
@dp.callback_query(F.data.startswith("answer_"))
async def handle_answer(callback: types.CallbackQuery, state: FSMContext):
    parts = callback.data.split("_")
    q_index = int(parts[1])
    user_answer = int(parts[2])

    q = HTML_TEST[q_index]
    correct_index = q["answer"]

    data = await state.get_data()
    correct_count = data.get("correct", 0)
    answers = data.get("answers", {})
    answers[q_index] = user_answer

    if user_answer == correct_index:
        correct_count += 1
        await callback.message.answer("‚úÖ To'g'ri javob!")
    else:
        await callback.message.answer(f"‚ùå Noto'g'ri.\nTo'g'ri javob: <b>{q['options'][correct_index]}</b>")

    await state.update_data(index=q_index + 1, correct=correct_count, answers=answers)

    # Countdown 10 soniya
    msg = await callback.message.answer("‚è≥ Keyingi savol 10 soniyadan keyin...")
    for i in range(10, 0, -1):
        await msg.edit_text(f"‚è≥ <b>{i} soniya qoldi...</b>")
        await asyncio.sleep(1)

    await callback.answer()
    await send_question(callback.message, state)


# === Bot ishga tushishi ===
if __name__ == "__main__":
    import asyncio
    from aiogram.fsm.storage.memory import MemoryStorage

    dp.fsm.storage = MemoryStorage()
    asyncio.run(dp.start_polling(bot))
