import os
import asyncio
import httpx
import json
import 
from aiogram import Router, types, F
from aiogram.utils.keyboard import InlineKeyboardBuilder
from aiogram.fsm.context import FSMContext

test = Router()
GENNIS_TOKEN = os.getenv(
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJmcmVzaCI6ZmFsc2UsImlhdCI6MTc2Mjg1NTIwMywianRpIjoiN2QzZjUwZjktYTJiZi00ODA5LWI1ZGYtZTk3M2U2YjA2ZjBmIiwidHlwZSI6ImFjY2VzcyIsInN1YiI6IjhkMDI3NzJjNTE5MzExZjBhNTQ4MzFkODQyNzBhMjIwIiwibmJmIjoxNzYyODU1MjAzLCJjc3JmIjoiZWRhMDllOTYtMWNmOC00YmNjLTg2YTMtNjc0NTAzYjgzZmQ5IiwiZXhwIjoxNzYyOTQxNjAzfQ.lRm38r8eo-t8G42UZe4Ne67wYTF6aXhRFJSiY5RfvJc")
TEST_LIST_URL = "https://classroom.gennis.uz/api/pisa/test/crud/34"
TEST_QUESTIONS_URL = "https://classroom.gennis.uz/api/pisa/test/crud/34"
TEST_FINISH_URL = "https://classroom.gennis.uz/api/pisa/student/finish"

active_questions = {}
HEADERS = lambda token: {
    "Authorization": f"Bearer {token}",
    "Accept": "application/json",
    "User-Agent": "GennisBot/1.0"
}


def get_tests():
    try:
        response = requests.get(TEST_LIST_URL, headers=headers)
        print("Status:", response.status_code)
        print("Response text:", response.text[:300])
        if response.status_code == 401:
            print("âŒ Token yemad")
            return []
        if response.status_code != 200:
            print("âš ï¸ Server yemad", response.status_code)
            return []
        data = response.json()
        if isinstance(data, list):
            return [
                {"id": item["id"], "name": item["name"]}
                for item in data if "id" in item and "name" in item
            ]
        else:
            print("âš ï¸ Format yemad", type(data))
    except Exception as e:
        print("âš ï¸ Test yemad", e)
    return []
async def get_test_questions(test_id: int):
    url = f"{TEST_QUESTIONS_URL}/{test_id}"
    async with httpx.AsyncClient(timeout=20) as client:
        resp = await client.get(url, headers=HEADERS(GENNIS_TOKEN))
    if resp.status_code != 200:
        return []
    data = resp.json()
    return data.get("questions", [])


async def mark_test_finished(test_id: int):
    url = f"{TEST_FINISH_URL}/{test_id}"
    async with httpx.AsyncClient(timeout=20) as client:
        resp = await client.post(url, headers=HEADERS(GENNIS_TOKEN))
    return resp.status_code == 200


@test.message(F.text == "ğŸ“ Testni boshlash")
async def start_test_handler(message: types.Message, state: FSMContext):
    tests = await get_tests()
    if not tests:
        return await message.answer("âŒ Testlar topilmadi!")
    builder = InlineKeyboardBuilder()
    for t in tests:
        builder.button(text=t["name"], callback_data=f"variant_{t['id']}")
    builder.adjust(1)
    await message.answer("ğŸ§  Qaysi testni tanlaysiz?", reply_markup=builder.as_markup())
    await state.clear()


@test.callback_query(F.data.startswith("variant_"))
async def choose_variant(callback: types.CallbackQuery, state: FSMContext):
    test_id = int(callback.data.split("_")[1])
    questions = await get_test_questions(test_id)
    if not questions:
        await callback.message.answer("âŒ Bu testda savollar yoâ€˜q!")
        await callback.answer()
        return
    await state.update_data(index=0, correct=0, test_id=test_id, questions=questions)
    await callback.message.answer("âœ… Test boshlandi!")
    await callback.answer()
    await send_question(callback.message, state)


async def send_question(message: types.Message, state: FSMContext):
    data = await state.get_data()
    index = data.get("index", 0)
    questions = data.get("questions", [])
    correct = data.get("correct", 0)

    if index >= len(questions):
        total = len(questions)
        percent = (correct / total) * 100
        await message.answer(f"ğŸ‰ Test tugadi!\nğŸ Natija: {correct}/{total} ({percent:.1f}%)")
        await mark_test_finished(data["test_id"])
        await state.clear()
        return

    q = questions[index]
    text = q.get("q", "")
    options = q.get("options", [])
    builder = InlineKeyboardBuilder()
    for i, opt in enumerate(options):
        builder.button(text=opt, callback_data=f"answer_{index}_{i}")
    builder.adjust(1)

    msg = await message.answer(
        f"ğŸ§© <b>{text}</b>\nâ³ <b>10 soniya qoldi</b>",
        parse_mode="HTML",
        reply_markup=builder.as_markup()
    )

    async def countdown():
        for sec in range(9, 0, -1):
            try:
                await asyncio.sleep(1)
                await msg.edit_text(
                    f"ğŸ§© <b>{text}</b>\nâ³ <b>{sec} soniya qoldi</b>",
                    parse_mode="HTML",
                    reply_markup=builder.as_markup()
                )
            except:
                return
        data = await state.get_data()
        if data.get("index", 0) == index:
            await state.update_data(index=index + 1)
            await send_question(message, state)

    task = asyncio.create_task(countdown())
    active_questions[msg.message_id] = task


@test.callback_query(F.data.startswith("answer_"))
async def handle_answer(callback: types.CallbackQuery, state: FSMContext):
    task = active_questions.pop(callback.message.message_id, None)
    if task:
        task.cancel()

    _, q_index, user_answer = callback.data.split("_")
    q_index = int(q_index)
    user_answer = int(user_answer)
    data = await state.get_data()
    questions = data.get("questions", [])
    correct = data.get("correct", 0)
    correct_index = questions[q_index].get("answer", -1)

    if user_answer == correct_index:
        correct += 1
        await callback.message.answer("âœ… Togri!")
    else:
        await callback.message.answer("âŒ Notogri!")

    total = len(questions)
    percent = (correct / total) * 100
    await callback.message.answer(f"ğŸ“Š Natija: {correct}/{total} ({percent:.1f}%)")

    await state.update_data(correct=correct, index=q_index + 1)
    await callback.answer()
    await send_question(callback.message, state)
